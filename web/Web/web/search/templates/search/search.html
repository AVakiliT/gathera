{% extends "base.html" %}
{% load static %}

{% block pagetitle %}Search{% endblock %}

{%block main-class%}col-md-12 pt-4 px-0{%endblock%}

{% block navbar-noncollapse %}
<form id="search_form" name="search_input" class="input-group mx-auto w-50 d-lg-none order-sm-1 order-md-3 align-self-center search-input text-dark">
    <input autocomplete="off" class="form-control search_input-sm py-2 mr-1 pr-5 search-input bg-light text-dark shadow-none rounded-sm" type="search" placeholder="Search" id="search_input-sm" name="search_input">
    <span class="input-group-append">
     <button class="btn rounded-pill border-0 ml-n5 p-0 pl-2" type="submit"
         ic-indicator="#searchSpinner" ic-target="#search_result"
         ic-include="#search_input-sm" ic-post-to="{% url 'search:get_docs' %}"
          >
        <i class="fas fa-search text-secondary"></i>
     </button>
    </span>
</form>
{% endblock %}

{% block navbar-center %}
<form id="search_form" name="search_input" class="input-group mx-auto w-75 search-input text-dark">
  <input autocomplete="off" class="form-control py-2 mr-1 pr-5 search-input bg-light text-dark border-0 shadow-none rounded-sm" type="search" placeholder="Search" id="search_input" name="search_input">
  <span class="input-group-append">
     <button class="btn rounded-pill border-0 ml-n5 p-0 pl-2" type="submit"
             ic-target="#search_result" ic-include="#search_input" ic-post-to="{% url 'search:get_docs' %}"
     >
  	  <i class="fas fa-search text-secondary"></i>
     </button>
    </span>
</form>
{% endblock %}

{% block main %}
<div class="row flex-items-lg-middle">
</div>

<div class="col-12 pt-2 mr-auto">
  <div id="search_result">
  </div>
</div>

<!-- Document modal -->
{% include 'modals/document_modal.html' %}

{% endblock %}

{% block extra_scripts %}
    <script src="http://cdn.intercoolerjs.org/intercooler-1.1.1.min.js"></script>
    <script src="{% static 'js/mousetrap.min.js' %}"></script>
    <script src="https://unpkg.com/runtime-memcache@2.0.0"></script>
    <script src="{% static 'js/moment.min.js' %}"></script>
    <script src="{% static 'js/document-viewer.js' %}"></script>
    <script src="{% static 'js/highlight.js' %}"></script>

    <script>

        var dv = new docView();
        dv.init({
          singleDocumentMode: true,
          searchMode: true,
          getDocumentsToJudgeURL: '{% url 'CAL:get_docs' %}',
          getPrevDocumentsJudgedURL: '{% url 'judgment:get_latest' number_of_docs_to_show=50 %}',
          getDocumentIDsToJudgeURL: '{% url 'CAL:get_docs_ids' %}',
          sendDocumentJudgmentURL: '{% url 'judgment:post_judgment' %}',
          getDocumentURL: '{% url 'core:get_single_doc' %}?docid=',
          fetchPreviouslyJudgedDocsOnInit: false,
          csrfmiddlewaretoken: "{{ csrf_token }}",

          afterDocumentJudge: function(docid, rel) {
            // update document indicator in SERP
            console.log(docid, rel);
            let newColor = "#fff";
            switch (rel) {
              case 0:
                newColor = "#a5a5a5"; break;
              case 1:
                newColor = "#c6fab8"; break;
              case 2:
                newColor = "#84c273"; break;
            }
            $(`#doc_${docid}_SERP_indicator`).attr('style', `border-color:${newColor}`);
          }
        });

        var loaded_docs = {}; // dict of loaded documents to prevent reloading doc content.

        // flag to check if a modal is currently opened
        var isModalOpen = false;
        var currentOpenedModalDocId = null;

        $( "#search_input" ).focus(function() {
            var now = + new Date();
            $.ajax({
                url: '{% url 'search:post_search_status' %}',
                method: 'POST',
                data: JSON.stringify({
                    'client_time': now,
                    'isFocused': true,
                    'search_bar_value': $("#search_input").val(),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'page_title': document.title
                }),
                success: function (result) {
                    console.log(result['message']);
                }
            });

            console.log("Search input is focused.", now);
        });

        $( "#search_input").blur(function() {
            var now = + new Date();
            $.ajax({
                url: '{% url 'search:post_search_status' %}',
                method: 'POST',
                data: JSON.stringify({
                    'client_time': now,
                    'isFocused': false,
                    'search_bar_value': $("#search_input").val(),
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'page_title': document.title
                }),
                success: function (result) {
                    console.log(result['message']);
                }
            });
            console.log("Search input is unfocused.", now);
        });

        $('#search_button').on('beforeSend.ic',
            function(evt, elt, data, settings, xhr, requestId) {
                var now = + new Date();
                $.ajax({
                    url: '{% url 'search:post_search_request' %}',
                    method: 'POST',
                    data: JSON.stringify({
                        'client_time': now,
                        'query': $("#search_input").val(),
                        'numdisplay': $("#id_numdisplay").val(),
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'page_title': document.title
                    }),
                    success: function (result) {
                        console.log(result['message']);
                    }
                });
            });

        var search_form = document.querySelector('search_form');
        Mousetrap(search_form).handleKey = function handleKey(character, modifiers, event){
            if(event.type == "keydown" && $("#search_input").is(':focus')){
                var now = + new Date();
                $.ajax({
                    url: '{% url 'search:post_keystroke' %}',
                    method: 'POST',
                    data: JSON.stringify({
                        'client_time': now,
                        'page_title': document.title,
                        'character': character,
                        'search_bar_value': $("#search_input").val(),
                        'isSearchbarFocused': $("#search_input").is(':focus'),
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    }),
                    success: function (result) {
                        console.log(result['message']);
                    }
                });
                console.log("Character pressed: '"+character+"'", "at:", now);
            }
            document.body.click();
        };

        Mousetrap.bind(['h', 'r', 's'], function(e, key) {
            var current_doc_id = get_current_opened_modal_doc_id();
            if(current_doc_id == null){
                return;
            }
            var doc_title = $("#doc-"+current_doc_id+"-title").html();
            var doc_snippet = $("#doc-"+current_doc_id+"-snippet").html();

            if(key == 'h') {
                send_judgment_and_hide_modal(current_doc_id, doc_title, doc_snippet, 2, 'keyboard');
            } else if(key == 'r') {
                send_judgment_and_hide_modal(current_doc_id, doc_title, doc_snippet, 1, 'keyboard');
            } else if(key == 's') {
                send_judgment_and_hide_modal(current_doc_id, doc_title, doc_snippet, 0, 'keyboard');
            }
            document.body.click();
        });

        Mousetrap.bind(['ctrl+f', 'command+f'], function(e) {
            console.log("Ctrl+f triggered. isModalOpen: " + isModalOpen + ". currentOpenedModalDocId: " +  currentOpenedModalDocId);
            post_ctrlf();
            if(!isModalOpen){
                return;
            }
            e.preventDefault();
            var docid = get_current_opened_modal_doc_id();
            $( "#search_content_doc_"+docid).focus();
            document.body.click();
            return false;
        });

        function post_ctrlf(){
            var isOnSERP = !isModalOpen;
            var docid = null;
            if(isModalOpen){
                docid = get_current_opened_modal_doc_id();
            }
            var now = + new Date();
            $.ajax({
                url: '{% url 'core:post_ctrlf' %}',
                method: 'POST',
                data: JSON.stringify({
                    'client_time': now,
                    'page_title': document.title,
                    'extra_context': {
                        'doc_id': docid,
                        'isOnSERP': isOnSERP,
                        'isModalOpen': isModalOpen
                    },
                    'search_field_value': $("#search_content_doc_"+docid).val(),
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                }),
                success: function (result) {
                    console.log(result['message']);
                }
            });
        }

        function get_current_opened_modal_doc_id(){
            if(isModalOpen){
                return currentOpenedModalDocId;
            }
            else return null;
        }

        function send_judgment(doc_id, current_doc_title, current_doc_snippet, relevance, method, isFromSearchModal, historyItem, ctrlf_terms) {
            if(historyItem == null){
                var now = + new Date();
                historyItem = {
                    "timestamp": now,
                    "source": "searchSERP",
                    "judged": true,
                    "relevance": relevance,
                    "method": method,
                    'ctrl_f_terms_input': ctrlf_terms,
                    'found_ctrl_f_terms_in_title': marked_matches_in_document_title,
                    'found_ctrl_f_terms_in_full_doc': marked_matches_in_document_content
                };
            }else{
                var now = historyItem['timestamp'];
            }
            console.log("Sending judgment call to backend for document id: " + doc_id);
            let source = "search";
            if (isFromSearchModal) {
              source = "searchmodal"
            }
            var data = {
                'doc_id': doc_id,
                'doc_title': current_doc_title,
                'doc_CAL_snippet': "",
                'doc_search_snippet': current_doc_snippet,
                'query': $("#search_input").val(),
                'relevance': relevance,
                'source': source,
                'client_time': now,
                'method': method,
                'historyItem': historyItem,
                'search_query': $("#search_input").val(),
                'ctrl_f_terms_input': ctrlf_terms,
                'found_ctrl_f_terms_in_title': marked_matches_in_document_title,
                'found_ctrl_f_terms_in_summary': [],
                'found_ctrl_f_terms_in_full_doc': marked_matches_in_document_content,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'page_title': document.title
            };

            $.ajax({
                url: '{% url 'judgment:post_judgment' %}',
                method: 'POST',
                data: JSON.stringify(data),
                success: function (result) {
                    console.log(result['message']);
                    if(result['is_max_judged_reached']){
                        window.location.href = "{% url 'core:home' %}";
                    }
                },
                error: function (result) {
                    console.error("Something went wrong. " +
                            "Judgment may have not been recorded.", result['responseText'])
                }
            });

            update_doc_status(doc_id, relevance);

            return false;
        }

        var find_borders_css = function (index, className){return (className.match (/(^|\s)border-\S+/g) || []).join(' ');};
        function update_doc_status(doc_id, relevance){
            if(relevance === 2){
                $("#doc_"+doc_id+"_card").removeClass(find_borders_css).addClass("border-left border-3 border-success");
            }else if(relevance === 1){
                $("#doc_"+doc_id+"_card").removeClass(find_borders_css).addClass("border-left border-3 border-warning");
            }else if(relevance === 0){
                $("#doc_"+doc_id+"_card").removeClass(find_borders_css).addClass("border-left border-3 border-danger");
            }
            document.getElementById("isJudged_"+doc_id).style.display = "inherit";
        }

        function hide_modal(doc_id){
            $('#doc-'+doc_id+'-modal').modal('hide');
            resetMatchesLists();
        }

        function send_judgment_and_hide_modal(doc_id, doc_title, doc_snippet, relevance, method){
            var now = + new Date;

            var ctrlf_terms = $("#search_content_doc_"+doc_id).val();
            var historyItem = {
                "timestamp": now,
                "source": "searchModal",
                "judged": true,
                "relevance": relevance,
                "method": method,
                "ctrl_f_terms_input": ctrlf_terms,
                "found_ctrl_f_terms_in_title": marked_matches_in_document_title,
                "found_ctrl_f_terms_in_full_doc": marked_matches_in_document_content
            };
            send_judgment(doc_id, doc_title, doc_snippet, relevance, method,  true, historyItem, ctrlf_terms);
            var element = document;
            var event = new CustomEvent("new_judgment");
            element.dispatchEvent(event);
            hide_modal(doc_id);
            return false;
        }
        var is_from_judgment = false;
        var element = document;
        element.addEventListener("new_judgment", function (e) {
            is_from_judgment = true;
        }, false);

        var marked_matches_in_document_title = [];
        var marked_matches_in_document_content = [];
        /**
        * Update dicts of matches in document title, and content
        */
        function updateMatchesLists(){
            resetMatchesLists();
            var document_title_mark_instances = $("#modal-title-"+currentOpenedModalDocId).find("mark");
            var document_content_mark_instances = $("#document_"+currentOpenedModalDocId+"_raw_content").find("mark");

            var i;
            for(i = 0; i < document_title_mark_instances.length; i++){
                var data = {
                    "match": document_title_mark_instances[i].innerHTML,
                    "wholeWord": get_surroundings_of_match(document_title_mark_instances[i])
                };
                marked_matches_in_document_title.push(data);
            }
            for(i = 0; i < document_content_mark_instances.length; i++){
                var data = {
                    "match": document_content_mark_instances[i].innerHTML,
                    "wholeWord": get_surroundings_of_match(document_content_mark_instances[i])
                };
                marked_matches_in_document_content.push(data);
            }
        }

        /**
         * Gets the surrounding letters of a highlighted match.
         * E.g. "The company is ba<mark>se</mark>d in California"
         * retrun "based".
         */
        function get_surroundings_of_match(match){
            if(match.previousSibling != undefined && match.nextSibling != undefined){
                var prev = match.previousSibling.nodeValue;
                var next = match.nextSibling.nodeValue;
                if(prev == ""){
                    prev = " ";
                }
                if(next == ""){
                    next = " ";
                }

                var wholeMatch = [];
                var i;
                for(i = 0; i < prev.length; i++){
                    var index = prev.length - i - 1;
                    if(prev[index] != "" && prev[index] != " ") {
                        wholeMatch.push(prev[index]);
                    } else {
                        break;
                    }
                }
                wholeMatch.reverse();
                wholeMatch.push.apply(wholeMatch, match.innerHTML.split());
                for(i = 0; i < next.length; i++){
                    if(next[i] != "" && next[i] != " "){
                        wholeMatch.push(next[i]);
                    }else{
                        break;
                    }
                }
                return wholeMatch.join("");
            }else {
                return null;
            }
        }

        function resetMatchesLists(){
            marked_matches_in_document_title = [];
            marked_matches_in_document_content = [];
        }

    </script>
{% endblock %}
